const interpreter = require("../../interpreter.js")

module.exports = async d => {
 
  const code = d.command.code
  
  const r = code.split("$textSplitMap").length - 1
  
  const inside = code.split("$textSplitMap[")[r].split("]")[0]
 
  const content = []

  const commands = inside.split(";")
      
  for (const value of d.array) {
    for (const command of commands) {
      const cmd = d.client.awaited_commands.find(c => c.name === command)

      if (!cmd) return d.error(`:x: Invalid awaited command '${command}' in \`$textSplitMap[${command}]\``)

      const newArgs = [...d.args]

      newArgs.unshift(value)

      const code = await interpreter(d.client, d.message, newArgs, cmd, undefined, true)

      if (code) content.push(code)
    }
  }

  return {
    code: code.replaceLast(`$textSplitMap[${inside}]`, content.join("\n")) 
  } 
} 